
# rucio-ams: Fermilab Rucio Deployment Framework 
## Scientific Data Management
### Brandon White
bjwhite@fnal.gov

### Dennis Lee
dylee@fnal.gov

## Introduction
This repository contains scripts and configurations to deploy [Rucio](https://rucio.cern.ch) to Kubernetes clusters at Fermilab.

This framework uses `kustomize` (`kubectl apply -k`) to allow modification of Helm template outputs from the official Rucio Helm chart. This is used in particular to patch the environment of containers such that they are configured to have the database connection string passed in via the value of a `Secret`. This allows us to keep the Kubernetes resource manifests generated by the Helm templates under version control, without exposing a base64 encoded password as compared with a `--values` injection to the Helm template process.

The secrets and credentials needed for the application will need to be pushed to Vault. Vault-resident secrets will be downloaded when `make apply` is run and then loaded into the cluster via `SecretGenerator` definitions in the `kustomization.yaml` files.

## Requirements
* `kubectl`
* Permission to access the Kubernetes cluster
* (For OKD Clusters) OpenShift CLI (`oc`)
* (Optional) `k9s` for easier management

## Usage
1. Have the following secrets stored in `overlays/<experiment>/rucio/etc/.secrets/`
    * `hostcert.pem`: Host server certificate
    * `hostkey.pem`: Host server key
    * `ca.pem`: CA Certificate bundle
    * `db-connstr`: Database Connection String 

    These secrets should optimally be downloaded from a secrets managment service (i.e. Vault) at deployment time for centrailized distribution, rather than being stored locally.

    **If using a custom policy package:**
    * Add `__init.py__`, `permission.py`, and `schema.py` to
`<rucio-ams>/overlays/<experiment>/etc/policy-package`
    * No other configuration is required, as the files are mounted as a secret. All policy packages will be referred to in the containers/config files as "fermilab", regardless of the experiment-specific policy package implementation files mounted.

2. Enter your desired experiment directory
```
    $ cd overlays/int
```
3. Use the proper Kubernetes cluster configuration
```
    $ oc project <experiment>

    # OR

    $ export KUBE_CONFIG=<path to kubernetes configuration>
```
3. Deploy Rucio for a given overlay using the Makefile in the experiment directory.
```
    $ make apply
```

### Mechanism in `make apply`
`make apply` runs multiple steps, which includes downloading Secrets from Vault (TODO), building K8s resourece manifests with Helm templates, and ending by using Kustomize to create or update the Rucio application resources.

## Project Structure
* `images`: Contains container images for use in our Rucio deployments
    * Most, if not all, of these are considered legacy, since we are now using the official images provided by the Rucio team (https://github.com/rucio/containers)
    * The `client` image is what we use for running custom scripts
* `overlays`: Contains configuration and scripts to deploy to experiments